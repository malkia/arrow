load("@bazel_skylib//rules:expand_template.bzl", "expand_template")
#load("@aspect_bazel_lib//lib:expand_make_vars.bzl", "expand_template")

# Root arrow C++ package

# Following CMakeLists.txt
# targets: arrow-all, arrow, arrow-benchmarks, arrow-tests, arrow-integration
# arrow-all: arrow arrow-tests arrow-benchmarks arrow-integration
# tests
# fuzzers
# benchmarks
#
# build flags:
#   ARROW_HAVE_RUNTIME_AVX2
#   ARROW_HAVE_RUNTIME_BMI2 (??) (seems to require AVX2)
#   ARROW_HAVE_RUNTIME_AVX512

package(
    default_visibility = ["//visibility:public"],
)

# Not complete rough patch from CMakeLists.txt
ARROW_VERSION_MINOR = 16

ARROW_VERSION_MAJOR = 0

ARROW_VERSION_PATCH = 0

ARROW_VERSION = "%d.%d.%d-bazel" % (ARROW_VERSION_MAJOR, ARROW_VERSION_MINOR, ARROW_VERSION_PATCH)

ARROW_SO_VERSION = "%d" % (ARROW_VERSION_MAJOR * 100 + ARROW_VERSION_MINOR)

ARROW_FULL_SO_VERSION = "%s.%d.%d" % (ARROW_SO_VERSION, ARROW_VERSION_PATCH, 0)

ARROW_PACKAGE_KIND = "bazel"  # From git-grepping, some of the other choices are: conan, vcpkg, python-wheel-macos, python-wheel-windows

CMAKE_CXX_COMPILER_ID = "todo_cmake_cxx_compiler_id"

CMAKE_CXX_COMPILER_VERSION = "todo_cmake_cxx_compiler_version"

CMAKE_CXX_FLAGS = "todo_cmake_cxx_flags"

UPPERCASE_BUILD_TYPE = "DEBUG"  # "RELEASE" ?

expand_template(
    name = "util_config_h",
    out = "util/config.h",
    substitutions = {
        "@ARROW_VERSION_MAJOR@": "%d" % ARROW_VERSION_MAJOR,
        "@ARROW_VERSION_MINOR@": "%d" % ARROW_VERSION_MINOR,
        "@ARROW_VERSION_PATCH@": "%d" % ARROW_VERSION_PATCH,
        "@ARROW_VERSION@": ARROW_VERSION,
        "@ARROW_SO_VERSION@": ARROW_SO_VERSION,
        "@ARROW_FULL_SO_VERSION@": ARROW_FULL_SO_VERSION,
        "@ARROW_GIT_DESCRIPTION@": "todo-git-description",
        "@ARROW_GIT_ID@": "todo-git-id",
        "@ARROW_PACKAGE_KIND@": ARROW_PACKAGE_KIND,
        "@CMAKE_CXX_COMPILER_ID@": CMAKE_CXX_COMPILER_ID,
        "@CMAKE_CXX_COMPILER_VERSION@": CMAKE_CXX_COMPILER_VERSION,
        "@CMAKE_CXX_FLAGS@": CMAKE_CXX_FLAGS,
        "@UPPERCASE_BUILD_TYPE@": UPPERCASE_BUILD_TYPE,
        # Example how to find uses in the code
        # git grep -E ".*#.*\bARROW_CSV\b"
        "#cmakedefine ARROW_COMPUTE": "",  # "#define ARROW_COMPUTE",
        "#cmakedefine ARROW_CSV": "",  # "#define ARROW_CSV",
        "#cmakedefine ARROW_CUDA": "",  # "#define ARROW_CUDA",
        "#cmakedefine ARROW_DATASET": "",  # "define ARROW_DATASET",
        "#cmakedefine ARROW_FILESYSTEM": "",  # "define ARROW_FILESYSTEM 0",
        "#cmakedefine ARROW_FLIGHT_SQL": "",  # "define ARROW_FLIGHT_SQL 0",
        "#cmakedefine ARROW_FLIGHT": "",  # "define ARROW_FLIGHT 0",
        "#cmakedefine ARROW_IPC": "",  # "define ARROW_IPC",
        "#cmakedefine ARROW_JEMALLOC_VENDORED": "",  # "define ARROW_JEMALLOC_VENDORED",
        "#cmakedefine ARROW_JEMALLOC": "",  # "define ARROW_JEMALLOC",
        "#cmakedefine ARROW_JSON": "",  # "define ARROW_JSON",
        "#cmakedefine ARROW_ORC": "",  # "define ARROW_ORC",
        "#cmakedefine ARROW_PARQUET": "",  # "define ARROW_PARQUET",
        "#cmakedefine ARROW_SUBSTRAIT": "",  # "define ARROW_SUBSTRAIT",
        "#cmakedefine ARROW_ENABLE_THREADING": "",  # "define ARROW_ENABLE_THREADING",
        "#cmakedefine ARROW_GCS": "",  # "define ARROW_GCS",
        "#cmakedefine ARROW_S3": "",  # "define ARROW_S3",
        "#cmakedefine ARROW_USE_NATIVE_INT128": "#define ARROW_USE_NATIVE_INT128",
        "#cmakedefine ARROW_WITH_MUSL": "",  # "define ARROW_WITH_MUSL",
        "#cmakedefine ARROW_WITH_OPENTELEMETRY": "",  # "define ARROW_WITH_OPENTELEMETRY",
        "#cmakedefine ARROW_WITH_UCX": "",  # "define ARROW_WITH_UCX",
        "#cmakedefine PARQUET_REQUIRE_ENCRYPTION": "",  # "define PARQUET_REQUIRE_ENCRYPTION",
    },
    template = "util/config.h.cmake",
)

# From CMakeLists.txt
ARROW_SRCS = [
    "array/array_base.cc",
    "array/array_binary.cc",
    "array/array_decimal.cc",
    "array/array_dict.cc",
    "array/array_nested.cc",
    "array/array_primitive.cc",
    "array/array_run_end.cc",
    "array/builder_adaptive.cc",
    "array/builder_base.cc",
    "array/builder_binary.cc",
    "array/builder_decimal.cc",
    "array/builder_dict.cc",
    "array/builder_nested.cc",
    "array/builder_primitive.cc",
    "array/builder_run_end.cc",
    "array/builder_union.cc",
    "array/concatenate.cc",
    "array/data.cc",
    "array/diff.cc",
    "array/util.cc",
    "array/validate.cc",
    "buffer.cc",
    "builder.cc",
    "c/bridge.cc",
    "c/dlpack.cc",
    "chunk_resolver.cc",
    "chunked_array.cc",
    "compare.cc",
    "config.cc",
    "datum.cc",
    "device.cc",
    "extension_type.cc",
    "io/buffered.cc",
    "io/caching.cc",
    "io/compressed.cc",
    "io/file.cc",
    "io/interfaces.cc",
    "io/memory.cc",
    "io/slow.cc",
    "io/stdio.cc",
    "io/transform.cc",
    "memory_pool.cc",
    "pretty_print.cc",
    "record_batch.cc",
    "result.cc",
    "scalar.cc",
    "sparse_tensor.cc",
    "status.cc",
    "table_builder.cc",
    "table.cc",
    "tensor.cc",
    "tensor/coo_converter.cc",
    "tensor/csf_converter.cc",
    "tensor/csx_converter.cc",
    "type_traits.cc",
    "type.cc",
    "util/align_util.cc",
    "util/async_util.cc",
    "util/atfork_internal.cc",
    "util/basic_decimal.cc",
    "util/bit_block_counter.cc",
    "util/bit_run_reader.cc",
    "util/bit_util.cc",
    "util/bitmap_builders.cc",
    "util/bitmap_ops.cc",
    "util/bitmap.cc",
    "util/bpacking.cc",
    "util/byte_size.cc",
    "util/cancel.cc",
    "util/compression.cc",
    "util/counting_semaphore.cc",
    "util/cpu_info.cc",
    "util/crc32.cc",
    "util/debug.cc",
    "util/decimal.cc",
    "util/delimiting.cc",
    "util/dict_util.cc",
    "util/float16.cc",
    "util/formatting.cc",
    "util/future.cc",
    "util/hashing.cc",
    "util/int_util.cc",
    "util/io_util.cc",
    "util/key_value_metadata.cc",
    "util/list_util.cc",
    "util/logging.cc",
    "util/memory.cc",
    "util/mutex.cc",
    "util/ree_util.cc",
    "util/string_builder.cc",
    "util/string.cc",
    "util/task_group.cc",
    "util/tdigest.cc",
    "util/thread_pool.cc",
    "util/time.cc",
    "util/tracing.cc",
    "util/trie.cc",
    "util/union_util.cc",
    "util/unreachable.cc",
    "util/uri.cc",
    "util/utf8.cc",
    "util/value_parsing.cc",
    "vendored/base64.cpp",
    "visitor.cc",
    #    "io/hdfs_internal.cc",
    #    "io/hdfs.cc",
]

ARROW_HDRS = [
    "array.h",
    "array/array_base.h",
    "array/array_binary.h",
    "array/array_decimal.h",
    "array/array_dict.h",
    "array/array_nested.h",
    "array/array_primitive.h",
    "array/array_run_end.h",
    "array/builder_adaptive.h",
    "array/builder_base.h",
    "array/builder_binary.h",
    "array/builder_decimal.h",
    "array/builder_dict.h",
    "array/builder_nested.h",
    "array/builder_primitive.h",
    "array/builder_run_end.h",
    "array/builder_time.h",
    "array/builder_union.h",
    "array/concatenate.h",
    "array/data.h",
    "array/dict_internal.h",
    "array/diff.h",
    "array/util.h",
    "array/validate.h",
    "buffer_builder.h",
    "buffer.h",
    "builder.h",
    "c/abi.h",
    "c/bridge.h",
    "c/dlpack_abi.h",
    "c/dlpack.h",
    "c/helpers.h",
    "c/util_internal.h",
    "chunk_resolver.h",
    "chunked_array.h",
    "compare.h",
    "compute/api_aggregate.h",
    "compute/api_scalar.h",
    "compute/api_vector.h",
    "compute/api.h",
    "compute/cast.h",
    "compute/exec.h",
    "compute/expression.h",
    "compute/function_options.h",
    "compute/function.h",
    "compute/kernel.h",
    "compute/ordering.h",
    "compute/registry.h",
    "compute/row/grouper.h",
    "compute/type_fwd.h",
    "config.h",
    "datum.h",
    "device.h",
    "extension_type.h",
    "io/buffered.h",
    "io/caching.h",
    "io/compressed.h",
    "io/concurrency.h",
    "io/file.h",
    "io/interfaces.h",
    "io/memory.h",
    "io/mman.h",
    "io/slow.h",
    "io/stdio.h",
    "io/transform.h",
    "io/type_fwd.h",
    "io/util_internal.h",
    "memory_pool_internal.h",
    "memory_pool.h",
    "pretty_print.h",
    "record_batch.h",
    "result.h",
    "scalar.h",
    "sparse_tensor.h",
    "status.h",
    "stl_allocator.h",
    "stl_iterator.h",
    "table_builder.h",
    "table.h",
    "tensor.h",
    "tensor/converter_internal.h",
    "tensor/converter.h",
    "type_fwd.h",
    "type_traits.h",
    "type.h",
    "util/algorithm.h",
    "util/align_util.h",
    "util/aligned_storage.h",
    "util/async_generator_fwd.h",
    "util/async_generator.h",
    "util/async_util.h",
    "util/atfork_internal.h",
    "util/base64.h",
    "util/basic_decimal.h",
    "util/binary_view_util.h",
    "util/bit_block_counter.h",
    "util/bit_run_reader.h",
    "util/bit_util.h",
    "util/bitmap_builders.h",
    "util/bitmap_generate.h",
    "util/bitmap_ops.h",
    "util/bitmap_reader.h",
    "util/bitmap_writer.h",
    "util/bitmap.h",
    "util/bpacking_default.h",
    "util/bpacking.h",
    "util/bpacking64_default.h",
    "util/byte_size.h",
    "util/cancel.h",
    "util/checked_cast.h",
    "util/compare.h",
    "util/compression_internal.h",
    "util/compression.h",
    "util/config.h",
    "util/counting_semaphore.h",
    "util/cpu_info.h",
    "util/crc32.h",
    "util/debug.h",
    "util/decimal_internal.h",
    "util/decimal.h",
    "util/delimiting.h",
    "util/dict_util.h",
    "util/dispatch.h",
    "util/double_conversion.h",
    "util/endian.h",
    "util/float16.h",
    "util/formatting.h",
    "util/functional.h",
    "util/future.h",
    "util/hash_util.h",
    "util/hashing.h",
    "util/int_util_overflow.h",
    "util/int_util.h",
    "util/int128_internal.h",
    "util/io_util.h",
    "util/iterator.h",
    "util/key_value_metadata.h",
    "util/launder.h",
    "util/list_util.h",
    "util/logging.h",
    "util/macros.h",
    "util/math_constants.h",
    "util/memory.h",
    "util/mutex.h",
    "util/queue.h",
    "util/range.h",
    "util/ree_util.h",
    "util/simd.h",
    "util/slice_util_internal.h",
    "util/small_vector.h",
    "util/sort.h",
    "util/span.h",
    "util/string_builder.h",
    "util/string.h",
    "util/task_group.h",
    "util/tdigest.h",
    "util/thread_pool.h",
    "util/time.h",
    "util/tracing_internal.h",
    "util/tracing.h",
    "util/trie.h",
    "util/type_fwd.h",
    "util/type_traits.h",
    "util/ubsan.h",
    "util/union_util.h",
    "util/unreachable.h",
    "util/uri.h",
    "util/utf8_internal.h",
    "util/utf8.h",
    "util/value_parsing.h",
    "util/vector.h",
    "util/visibility.h",
    "util/windows_compatibility.h",
    "util/windows_fixup.h",
    "vendored/ProducerConsumerQueue.h",
    "vendored/strptime.h",
    "vendored/datetime.h",
    "vendored/xxhash.h",
    "visit_array_inline.h",
    "visit_data_inline.h",
    "visit_scalar_inline.h",
    "visit_type_inline.h",
    "visitor_generate.h",
    "visitor.h",
    #    "filesystem/hdfs.h",
    #    "io/hdfs_internal.h",
    #    "io/hdfs.h",
    #    "parse_number.h",
    #    "builder.h",
]

cc_library(
    name = "config",
    defines = ["ARROW_STATIC=1"],
)

cc_library(
    name = "arrow",
    srcs = ARROW_SRCS,
    hdrs = ARROW_HDRS,
    include_prefix = "arrow",
    deps = [
        "config",
        "//cpp/src/arrow/vendored/datetime",
        "//cpp/src/arrow/vendored/double-conversion",
        "//cpp/src/arrow/vendored/fast_float",
        "//cpp/src/arrow/vendored/portable-snippets",
        "//cpp/src/arrow/vendored/uriparser",
        "//cpp/src/arrow/vendored/utfcpp",
        "//cpp/src/arrow/vendored/xxhash",
    ],
)

cc_test(
    name = "status_test",
    srcs = ["status_test.cc"],
    deps = [
        "arrow",
        "@googletest//:gtest",
    ],
)
